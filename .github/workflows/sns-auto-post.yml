# SNS Auto Post Workflow
# Phase 3: SNS í¬ìŠ¤íŒ… í•µì‹¬ ë¡œì§ + Phase 4: í”Œë«í¼ë³„ í¬ìŠ¤íŒ…
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” Notionì—ì„œ Ready ìƒíƒœ ê¸€ì„ ì¡°íšŒí•˜ê³ ,
# SNSìš© ì½˜í…ì¸ ë¡œ ë³€í™˜í•œ ë’¤ X, LinkedIn, Threadsì— í¬ìŠ¤íŒ…í•©ë‹ˆë‹¤.
#
# íŠ¸ë¦¬ê±°:
#   - ë§¤ì‹œê°„ ì •ê° (Cron)
#   - ìˆ˜ë™ ì‹¤í–‰ (workflow_dispatch)
#
# í•„ìˆ˜ Secrets:
#   - NOTION_API_KEY: Notion Integration í† í°
#   - NOTION_DATABASE_ID: ë¸”ë¡œê·¸ ë°ì´í„°ë² ì´ìŠ¤ ID
#   - NEXT_PUBLIC_BASE_URL: ë¸”ë¡œê·¸ ë„ë©”ì¸
#
# ì„ íƒ Secrets:
#   - AI_GATEWAY_API_KEY: Vercel AI Gateway í‚¤ (ë¯¸ì„¤ì • ì‹œ Fallback ì‚¬ìš©)

name: SNS Auto Post

on:
  schedule:
    - cron: "0 * * * *" # ë§¤ì‹œê°„ ì •ê°
  workflow_dispatch: # ìˆ˜ë™ íŠ¸ë¦¬ê±°
    inputs:
      dry_run:
        description: "Dry run (ì‹¤ì œ í¬ìŠ¤íŒ… ì—†ì´ í…ŒìŠ¤íŠ¸)"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

env:
  # ì½˜í…ì¸  ê¸€ì ìˆ˜ ì œí•œ
  MAX_SHORT_CHARS: 200
  MAX_LONG_CHARS: 400
  # Notion API ë²„ì „
  NOTION_API_VERSION: "2022-06-28"

jobs:
  prepare-content:
    name: Prepare SNS Content
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    outputs:
      has_posts: ${{ steps.notion.outputs.has_posts }}
      page_id: ${{ steps.notion.outputs.page_id }}
      title: ${{ steps.notion.outputs.title }}
      post_short: ${{ steps.compose.outputs.post_short }}
      post_long: ${{ steps.compose.outputs.post_long }}
      blog_url: ${{ steps.format.outputs.blog_url }}
      hashtags: ${{ steps.format.outputs.hashtags }}
      transform_method: ${{ steps.compose.outputs.transform_method }}

    steps:
      # ============================================
      # Step 1: Checkout (ì›Œí¬í”Œë¡œìš° íŒŒì¼ ì ‘ê·¼ìš©)
      # ============================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ============================================
      # Step 2: Notionì—ì„œ Ready ìƒíƒœ ê¸€ ì¡°íšŒ
      # ============================================
      - name: Fetch Ready posts from Notion
        id: notion
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          echo "ğŸ“¥ Fetching Ready posts from Notion..."

          # API í‚¤ í™•ì¸
          if [ -z "$NOTION_API_KEY" ] || [ -z "$NOTION_DATABASE_ID" ]; then
            echo "âŒ NOTION_API_KEY or NOTION_DATABASE_ID not configured"
            echo "has_posts=false" >> $GITHUB_OUTPUT
            echo "error=missing_config" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Notion API í˜¸ì¶œ (Status = "Ready" í•„í„°)
          # ì°¸ê³ : í•œê¸€ ì†ì„±ëª… "ìƒíƒœ" ì‚¬ìš©
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.notion.com/v1/databases/${NOTION_DATABASE_ID}/query" \
            -H "Authorization: Bearer ${NOTION_API_KEY}" \
            -H "Notion-Version: ${{ env.NOTION_API_VERSION }}" \
            -H "Content-Type: application/json" \
            --data '{
              "filter": {
                "property": "ìƒíƒœ",
                "status": {
                  "equals": "Ready"
                }
              },
              "page_size": 1
            }')

          # HTTP ìƒíƒœ ì½”ë“œ ë¶„ë¦¬
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          # API í˜¸ì¶œ ì‹¤íŒ¨ ì²´í¬
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Notion API returned HTTP $HTTP_CODE"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            echo "has_posts=false" >> $GITHUB_OUTPUT
            echo "error=api_error" >> $GITHUB_OUTPUT
            echo "error_code=$HTTP_CODE" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ê²°ê³¼ ê°œìˆ˜ í™•ì¸
          COUNT=$(echo "$BODY" | jq '.results | length')
          echo "ğŸ“Š Found $COUNT posts with Ready status"

          if [ "$COUNT" -eq 0 ]; then
            echo "has_posts=false" >> $GITHUB_OUTPUT
            echo "âœ… No posts to process"
            exit 0
          fi

          echo "has_posts=true" >> $GITHUB_OUTPUT

          # ì²« ë²ˆì§¸ í¬ìŠ¤íŠ¸ ì¶”ì¶œ
          FIRST_POST=$(echo "$BODY" | jq '.results[0]')
          PAGE_ID=$(echo "$FIRST_POST" | jq -r '.id')

          # ì†ì„± ì¶”ì¶œ (í•œê¸€/ì˜ë¬¸ ì†ì„±ëª… ëª¨ë‘ ì§€ì›)
          # Title: ì´ë¦„ ë˜ëŠ” Name
          TITLE=$(echo "$FIRST_POST" | jq -r '
            .properties["ì´ë¦„"].title[0].plain_text //
            .properties["Name"].title[0].plain_text //
            .properties["ì œëª©"].title[0].plain_text //
            "Untitled"
          ')

          # Description: ì„¤ëª… ë˜ëŠ” Description
          DESCRIPTION=$(echo "$FIRST_POST" | jq -r '
            .properties["ì„¤ëª…"].rich_text[0].plain_text //
            .properties["Description"].rich_text[0].plain_text //
            .properties["ìš”ì•½"].rich_text[0].plain_text //
            ""
          ')

          # Tags: íƒœê·¸ ë˜ëŠ” Tags (ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´)
          TAGS=$(echo "$FIRST_POST" | jq -r '
            [
              .properties["íƒœê·¸"].multi_select[].name //
              .properties["Tags"].multi_select[].name
            ] | join(",")
          ')

          # ì¶œë ¥ (ë©€í‹°ë¼ì¸ ì§€ì›)
          echo "page_id=$PAGE_ID" >> $GITHUB_OUTPUT

          # Title (ë©€í‹°ë¼ì¸ ê°€ëŠ¥ì„± ìˆìŒ)
          echo "title<<EOFTITLE" >> $GITHUB_OUTPUT
          echo "$TITLE" >> $GITHUB_OUTPUT
          echo "EOFTITLE" >> $GITHUB_OUTPUT

          # Description (ë©€í‹°ë¼ì¸)
          echo "description<<EOFDESC" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "EOFDESC" >> $GITHUB_OUTPUT

          echo "tags=$TAGS" >> $GITHUB_OUTPUT

          echo "âœ… Post data extracted:"
          echo "   - ID: $PAGE_ID"
          echo "   - Title: $TITLE"
          echo "   - Tags: $TAGS"
          echo "   - Description length: ${#DESCRIPTION} chars"

      # ============================================
      # Step 3: AI Gateway ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
      # ============================================
      - name: Check AI Gateway availability
        id: check-ai
        if: steps.notion.outputs.has_posts == 'true'
        run: |
          if [ -n "${{ secrets.AI_GATEWAY_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "âœ… AI Gateway is configured"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ AI Gateway not configured, will use fallback transformation"
          fi

      # ============================================
      # Step 4a: AI Gatewayë¥¼ ì‚¬ìš©í•œ ì½˜í…ì¸  ë³€í™˜
      # ============================================
      - name: Transform content with AI Gateway
        id: transform-ai
        if: steps.notion.outputs.has_posts == 'true' && steps.check-ai.outputs.available == 'true'
        uses: vercel/ai-action@v2
        with:
          model: "openai/gpt-4o"
          api-key: ${{ secrets.AI_GATEWAY_API_KEY }}
          system: |
            ë¸”ë¡œê·¸ ê¸€ì„ SNS í¬ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

            ê·œì¹™:
            - í•µì‹¬ ë‚´ìš©ë§Œ ê°„ê²°í•˜ê²Œ ìš”ì•½
            - ì´ëª¨ì§€ëŠ” ìµœì†Œí•œìœ¼ë¡œ ì‚¬ìš© (0-2ê°œ)
            - ì „ë¬¸ì ì´ì§€ë§Œ ì¹œê·¼í•œ í†¤ ìœ ì§€
            - í•œêµ­ì–´ë¡œ ì‘ì„±
            - í•´ì‹œíƒœê·¸ëŠ” í¬í•¨í•˜ì§€ ì•ŠìŒ (ë³„ë„ë¡œ ì²˜ë¦¬ë¨)
            - ë¸”ë¡œê·¸ ë§í¬ëŠ” í¬í•¨í•˜ì§€ ì•ŠìŒ (ë³„ë„ë¡œ ì¶”ê°€ë¨)

            short ë²„ì „: X(Twitter)ìš©, 200ì ì´ë‚´ë¡œ í•µì‹¬ë§Œ
            long ë²„ì „: LinkedIn/Threadsìš©, 400ì ì´ë‚´ë¡œ ìƒì„¸í•˜ê²Œ
          prompt: |
            ë‹¤ìŒ ë¸”ë¡œê·¸ ê¸€ì„ SNS í¬ìŠ¤íŠ¸ë¡œ ë³€í™˜í•´ì£¼ì„¸ìš”.

            ì œëª©: ${{ steps.notion.outputs.title }}

            ë‚´ìš©: ${{ steps.notion.outputs.description }}
          schema: |
            {
              "type": "object",
              "properties": {
                "short": {
                  "type": "string",
                  "description": "X(Twitter)ìš© ì§§ì€ ë²„ì „, 200ì ì´ë‚´"
                },
                "long": {
                  "type": "string",
                  "description": "LinkedIn/Threadsìš© ê¸´ ë²„ì „, 400ì ì´ë‚´"
                }
              },
              "required": ["short", "long"]
            }

      # ============================================
      # Step 4b: AI ë³€í™˜ ê²°ê³¼ ìº¡ì²˜
      # ============================================
      - name: Capture AI transform output
        id: ai-output
        if: steps.transform-ai.outputs.json != ''
        run: |
          echo "âœ… AI transformation complete"

          # JSON ì¶œë ¥ì—ì„œ short/long ì¶”ì¶œ
          SHORT='${{ fromJSON(steps.transform-ai.outputs.json).short }}'
          LONG='${{ fromJSON(steps.transform-ai.outputs.json).long }}'

          # ë©€í‹°ë¼ì¸ ì¶œë ¥
          echo "short<<EOFSHORT" >> $GITHUB_OUTPUT
          echo "$SHORT" >> $GITHUB_OUTPUT
          echo "EOFSHORT" >> $GITHUB_OUTPUT

          echo "long<<EOFLONG" >> $GITHUB_OUTPUT
          echo "$LONG" >> $GITHUB_OUTPUT
          echo "EOFLONG" >> $GITHUB_OUTPUT

          echo "method=ai" >> $GITHUB_OUTPUT

          echo "ğŸ“ Short: ${#SHORT} chars"
          echo "ğŸ“ Long: ${#LONG} chars"

      # ============================================
      # Step 4c: Fallback ë³€í™˜ (AI Gateway ë¯¸ì‚¬ìš© ì‹œ)
      # ============================================
      - name: Fallback transform (No AI)
        id: fallback
        if: steps.notion.outputs.has_posts == 'true' && steps.check-ai.outputs.available == 'false'
        env:
          TITLE: ${{ steps.notion.outputs.title }}
          DESCRIPTION: ${{ steps.notion.outputs.description }}
          MAX_SHORT: ${{ env.MAX_SHORT_CHARS }}
          MAX_LONG: ${{ env.MAX_LONG_CHARS }}
        run: |
          echo "ğŸ”„ Using fallback transformation..."

          # Descriptionì´ ë¹„ì–´ìˆìœ¼ë©´ Title ì‚¬ìš©
          if [ -z "$DESCRIPTION" ]; then
            CONTENT="$TITLE"
          else
            CONTENT="$DESCRIPTION"
          fi

          # ê¸€ì ìˆ˜ ìë¥´ê¸° (UTF-8 ì•ˆì „í•˜ê²Œ)
          # Short ë²„ì „
          SHORT=$(echo "$CONTENT" | head -c ${MAX_SHORT})
          CONTENT_LEN=$(echo "$CONTENT" | wc -c | tr -d ' ')
          if [ "$CONTENT_LEN" -gt "$MAX_SHORT" ]; then
            SHORT="${SHORT}..."
          fi

          # Long ë²„ì „
          LONG=$(echo "$CONTENT" | head -c ${MAX_LONG})
          if [ "$CONTENT_LEN" -gt "$MAX_LONG" ]; then
            LONG="${LONG}..."
          fi

          # ë©€í‹°ë¼ì¸ ì¶œë ¥
          echo "short<<EOFSHORT" >> $GITHUB_OUTPUT
          echo "$SHORT" >> $GITHUB_OUTPUT
          echo "EOFSHORT" >> $GITHUB_OUTPUT

          echo "long<<EOFLONG" >> $GITHUB_OUTPUT
          echo "$LONG" >> $GITHUB_OUTPUT
          echo "EOFLONG" >> $GITHUB_OUTPUT

          echo "method=fallback" >> $GITHUB_OUTPUT

          echo "âœ… Fallback transformation complete"
          echo "ğŸ“ Short: ${#SHORT} chars"
          echo "ğŸ“ Long: ${#LONG} chars"

      # ============================================
      # Step 5: í•´ì‹œíƒœê·¸ ë° ë¸”ë¡œê·¸ URL ìƒì„±
      # ============================================
      - name: Generate hashtags and blog URL
        id: format
        if: steps.notion.outputs.has_posts == 'true'
        env:
          TAGS: ${{ steps.notion.outputs.tags }}
          PAGE_ID: ${{ steps.notion.outputs.page_id }}
          BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}
        run: |
          echo "ğŸ·ï¸ Generating hashtags and URL..."

          # ê¸°ë³¸ URL ì„¤ì • (ë¯¸ì„¤ì • ì‹œ ë¹ˆ ë¬¸ìì—´)
          if [ -z "$BASE_URL" ]; then
            BASE_URL="https://example.com"
            echo "âš ï¸ NEXT_PUBLIC_BASE_URL not set, using placeholder"
          fi

          # í•´ì‹œíƒœê·¸ ë³€í™˜ (ê³µë°± ì œê±°, ìµœëŒ€ 5ê°œ)
          HASHTAGS=""
          if [ -n "$TAGS" ]; then
            IFS=',' read -ra TAG_ARRAY <<< "$TAGS"
            COUNT=0
            for tag in "${TAG_ARRAY[@]}"; do
              if [ $COUNT -ge 5 ]; then break; fi
              # ê³µë°± ì œê±° ë° trim
              clean_tag=$(echo "$tag" | tr -d ' ' | xargs)
              if [ -n "$clean_tag" ]; then
                HASHTAGS="${HASHTAGS}#${clean_tag} "
                COUNT=$((COUNT + 1))
              fi
            done
            HASHTAGS=$(echo "$HASHTAGS" | xargs)  # trim trailing space
          fi

          # ë¸”ë¡œê·¸ URL ìƒì„± (Notion UUID ê·¸ëŒ€ë¡œ ì‚¬ìš©)
          BLOG_URL="${BASE_URL}/blog/${PAGE_ID}"

          echo "hashtags=$HASHTAGS" >> $GITHUB_OUTPUT
          echo "blog_url=$BLOG_URL" >> $GITHUB_OUTPUT

          echo "âœ… Hashtags: $HASHTAGS"
          echo "âœ… Blog URL: $BLOG_URL"

      # ============================================
      # Step 6: ìµœì¢… í¬ìŠ¤íŠ¸ ì½˜í…ì¸  ì¡°ë¦½
      # ============================================
      - name: Compose final posts
        id: compose
        if: steps.notion.outputs.has_posts == 'true'
        env:
          TITLE: ${{ steps.notion.outputs.title }}
          SHORT_AI: ${{ steps.ai-output.outputs.short }}
          LONG_AI: ${{ steps.ai-output.outputs.long }}
          SHORT_FB: ${{ steps.fallback.outputs.short }}
          LONG_FB: ${{ steps.fallback.outputs.long }}
          METHOD_AI: ${{ steps.ai-output.outputs.method }}
          METHOD_FB: ${{ steps.fallback.outputs.method }}
          HASHTAGS: ${{ steps.format.outputs.hashtags }}
          BLOG_URL: ${{ steps.format.outputs.blog_url }}
        run: |
          echo "ğŸ“ Composing final posts..."

          # AI ë˜ëŠ” Fallback ê²°ê³¼ ì„ íƒ
          if [ -n "$SHORT_AI" ]; then
            SHORT="$SHORT_AI"
            LONG="$LONG_AI"
            TRANSFORM_METHOD="ai"
          else
            SHORT="$SHORT_FB"
            LONG="$LONG_FB"
            TRANSFORM_METHOD="fallback"
          fi

          # Xìš© í¬ìŠ¤íŠ¸ (280ì ì œí•œ ê³ ë ¤)
          # í˜•ì‹: ì œëª© + ë³¸ë¬¸ + í•´ì‹œíƒœê·¸ + URL
          POST_SHORT="${TITLE}

          ${SHORT}

          ${HASHTAGS}
          ${BLOG_URL}"

          # LinkedIn/Threadsìš© í¬ìŠ¤íŠ¸
          POST_LONG="${TITLE}

          ${LONG}

          ${HASHTAGS}

          ğŸ”— ${BLOG_URL}"

          # ë©€í‹°ë¼ì¸ ì¶œë ¥
          echo "post_short<<EOFPOSTSHORT" >> $GITHUB_OUTPUT
          echo "$POST_SHORT" >> $GITHUB_OUTPUT
          echo "EOFPOSTSHORT" >> $GITHUB_OUTPUT

          echo "post_long<<EOFPOSTLONG" >> $GITHUB_OUTPUT
          echo "$POST_LONG" >> $GITHUB_OUTPUT
          echo "EOFPOSTLONG" >> $GITHUB_OUTPUT

          echo "transform_method=$TRANSFORM_METHOD" >> $GITHUB_OUTPUT

          echo "âœ… Posts composed successfully"
          echo "ğŸ“ Short post length: $(echo "$POST_SHORT" | wc -c | tr -d ' ') chars"
          echo "ğŸ“ Long post length: $(echo "$POST_LONG" | wc -c | tr -d ' ') chars"

      # ============================================
      # Step 7: ì›Œí¬í”Œë¡œìš° ìš”ì•½ ìƒì„±
      # ============================================
      - name: Generate workflow summary
        if: always()
        env:
          HAS_POSTS: ${{ steps.notion.outputs.has_posts }}
          TITLE: ${{ steps.notion.outputs.title }}
          PAGE_ID: ${{ steps.notion.outputs.page_id }}
          TRANSFORM_METHOD: ${{ steps.compose.outputs.transform_method }}
          BLOG_URL: ${{ steps.format.outputs.blog_url }}
          HASHTAGS: ${{ steps.format.outputs.hashtags }}
          ERROR: ${{ steps.notion.outputs.error }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          echo "## ğŸ“± SNS Auto Post Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Dry Run í‘œì‹œ
          if [ "$DRY_RUN" = "true" ]; then
            echo "> ğŸ§ª **DRY RUN MODE** - No actual posting will occur" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY

          if [ "$ERROR" = "missing_config" ]; then
            echo "| Status | âŒ Configuration Error |" >> $GITHUB_STEP_SUMMARY
            echo "| Issue | NOTION_API_KEY or NOTION_DATABASE_ID not set |" >> $GITHUB_STEP_SUMMARY
          elif [ "$ERROR" = "api_error" ]; then
            echo "| Status | âŒ Notion API Error |" >> $GITHUB_STEP_SUMMARY
            echo "| Issue | Failed to query Notion database |" >> $GITHUB_STEP_SUMMARY
          elif [ "$HAS_POSTS" = "true" ]; then
            echo "| Ready Posts Found | âœ… Yes |" >> $GITHUB_STEP_SUMMARY
            echo "| Title | $TITLE |" >> $GITHUB_STEP_SUMMARY
            echo "| Page ID | \`$PAGE_ID\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Transform Method | $TRANSFORM_METHOD |" >> $GITHUB_STEP_SUMMARY
            echo "| Hashtags | $HASHTAGS |" >> $GITHUB_STEP_SUMMARY
            echo "| Blog URL | $BLOG_URL |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ready Posts Found | âŒ No |" >> $GITHUB_STEP_SUMMARY
            echo "| Status | â­ï¸ Skipped (no posts to process) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Workflow executed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # Step 8: ì—ëŸ¬ ë°œìƒ ì‹œ Issue ìƒì„±
      # ============================================
      - name: Create issue on Notion API error
        if: steps.notion.outputs.error == 'api_error'
        uses: actions/github-script@v7
        env:
          ERROR_CODE: ${{ steps.notion.outputs.error_code }}
        with:
          script: |
            const errorCode = process.env.ERROR_CODE || 'unknown';

            // ê¸°ì¡´ ì´ìŠˆ í™•ì¸
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'sns-auto-post-error',
              state: 'open'
            });

            if (issues.data.length > 0) {
              console.log('ğŸ“¢ Similar error issue already exists, skipping creation');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âŒ SNS Auto Post: Notion API ì˜¤ë¥˜',
              body: `## Notion API í˜¸ì¶œ ì‹¤íŒ¨

            **HTTP ìƒíƒœ ì½”ë“œ**: ${errorCode}

            **ê°€ëŠ¥í•œ ì›ì¸:**
            - Notion API í‚¤ê°€ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜ëª»ë¨
            - ë°ì´í„°ë² ì´ìŠ¤ IDê°€ ì˜ëª»ë¨
            - Notion Integrationì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°ë˜ì§€ ì•ŠìŒ
            - Notion API ì¼ì‹œì  ì¥ì• 

            **ì¡°ì¹˜ ë°©ë²•:**
            1. GitHub Secretsì—ì„œ \`NOTION_API_KEY\` í™•ì¸
            2. GitHub Secretsì—ì„œ \`NOTION_DATABASE_ID\` í™•ì¸
            3. Notionì—ì„œ Integration ì—°ê²° ìƒíƒœ í™•ì¸
            4. ì›Œí¬í”Œë¡œìš° ìˆ˜ë™ ì¬ì‹¤í–‰

            **ì‹¤í–‰ ë¡œê·¸:** [Actions Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ---
            *ì´ ì´ìŠˆëŠ” GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`,
              labels: ['bug', 'sns-auto-post-error']
            });

            console.log('ğŸ“¢ Error issue created');

  # ============================================
  # Phase 4: X (Twitter) í¬ìŠ¤íŒ…
  # ============================================
  post-to-x:
    name: Post to X (Twitter)
    runs-on: ubuntu-latest
    needs: [prepare-content]
    if: needs.prepare-content.outputs.has_posts == 'true'

    outputs:
      status: ${{ steps.result.outputs.status }}
      url: ${{ steps.result.outputs.url }}
      error: ${{ steps.result.outputs.error }}

    steps:
      - name: Check X API credentials
        id: check-creds
        run: |
          if [ -z "${{ secrets.X_API_KEY }}" ] || \
             [ -z "${{ secrets.X_API_SECRET }}" ] || \
             [ -z "${{ secrets.X_ACCESS_TOKEN }}" ] || \
             [ -z "${{ secrets.X_ACCESS_TOKEN_SECRET }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ X API credentials not fully configured, skipping"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "âœ… X API credentials configured"
          fi

      - name: Setup Node.js
        if: steps.check-creds.outputs.configured == 'true' && github.event.inputs.dry_run != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Post to X
        id: post
        if: steps.check-creds.outputs.configured == 'true'
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          POST_TEXT: ${{ needs.prepare-content.outputs.post_short }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ§ª DRY RUN: Would post to X"
            echo "ğŸ“ Content preview:"
            echo "$POST_TEXT" | head -c 100
            echo "..."
            echo "status=dry_run" >> $GITHUB_OUTPUT
            exit 0
          fi

          npm install twitter-api-v2

          node << 'EOFNODE'
          const { TwitterApi } = require('twitter-api-v2');
          const fs = require('fs');

          const client = new TwitterApi({
            appKey: process.env.X_API_KEY,
            appSecret: process.env.X_API_SECRET,
            accessToken: process.env.X_ACCESS_TOKEN,
            accessSecret: process.env.X_ACCESS_TOKEN_SECRET,
          });

          (async () => {
            try {
              const tweet = await client.v2.tweet(process.env.POST_TEXT);
              const tweetId = tweet.data.id;
              const tweetUrl = `https://x.com/i/status/${tweetId}`;

              console.log(`âœ… Tweet posted successfully!`);
              console.log(`ğŸ”— URL: ${tweetUrl}`);

              fs.appendFileSync(process.env.GITHUB_OUTPUT, `status=success\n`);
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `url=${tweetUrl}\n`);
            } catch (error) {
              console.error(`âŒ Failed to post tweet: ${error.message}`);

              fs.appendFileSync(process.env.GITHUB_OUTPUT, `status=error\n`);
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `error=${error.message.substring(0, 200)}\n`);
              process.exit(1);
            }
          })();
          EOFNODE

      - name: Set result outputs
        id: result
        if: always()
        env:
          CONFIGURED: ${{ steps.check-creds.outputs.configured }}
          POST_STATUS: ${{ steps.post.outputs.status }}
          POST_URL: ${{ steps.post.outputs.url }}
          POST_ERROR: ${{ steps.post.outputs.error }}
        run: |
          if [ "$CONFIGURED" = "false" ]; then
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "error=X API credentials not configured" >> $GITHUB_OUTPUT
          elif [ -n "$POST_STATUS" ]; then
            echo "status=$POST_STATUS" >> $GITHUB_OUTPUT
            echo "url=$POST_URL" >> $GITHUB_OUTPUT
            echo "error=$POST_ERROR" >> $GITHUB_OUTPUT
          else
            echo "status=error" >> $GITHUB_OUTPUT
            echo "error=Unknown error" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Phase 4: LinkedIn í¬ìŠ¤íŒ…
  # ============================================
  post-to-linkedin:
    name: Post to LinkedIn
    runs-on: ubuntu-latest
    needs: [prepare-content]
    if: needs.prepare-content.outputs.has_posts == 'true'

    outputs:
      status: ${{ steps.result.outputs.status }}
      url: ${{ steps.result.outputs.url }}
      error: ${{ steps.result.outputs.error }}

    steps:
      - name: Get LinkedIn token from Edge Config
        id: get-token
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          EDGE_CONFIG_ID: ${{ secrets.EDGE_CONFIG_ID }}
        run: |
          if [ -z "$VERCEL_TOKEN" ] || [ -z "$EDGE_CONFIG_ID" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Edge Config credentials not configured, skipping LinkedIn"
            exit 0
          fi

          RESPONSE=$(curl -s "https://edge-config.vercel.com/${EDGE_CONFIG_ID}?token=${VERCEL_TOKEN}")

          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.LINKEDIN_ACCESS_TOKEN // empty')

          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ LinkedIn access token not found in Edge Config"
            exit 0
          fi

          echo "configured=true" >> $GITHUB_OUTPUT
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
          echo "âœ… LinkedIn token retrieved from Edge Config"

      - name: Get LinkedIn user ID
        id: get-user
        if: steps.get-token.outputs.configured == 'true'
        env:
          ACCESS_TOKEN: ${{ steps.get-token.outputs.access_token }}
        run: |
          RESPONSE=$(curl -s "https://api.linkedin.com/v2/userinfo" \
            -H "Authorization: Bearer $ACCESS_TOKEN")

          PERSON_ID=$(echo "$RESPONSE" | jq -r '.sub // empty')

          if [ -z "$PERSON_ID" ] || [ "$PERSON_ID" = "null" ]; then
            echo "âŒ Failed to get LinkedIn user ID"
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"
            echo "user_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "person_id=$PERSON_ID" >> $GITHUB_OUTPUT
          echo "user_found=true" >> $GITHUB_OUTPUT
          echo "âœ… LinkedIn user ID: $PERSON_ID"

      - name: Post to LinkedIn
        id: post
        if: steps.get-user.outputs.user_found == 'true'
        env:
          ACCESS_TOKEN: ${{ steps.get-token.outputs.access_token }}
          PERSON_ID: ${{ steps.get-user.outputs.person_id }}
          POST_TEXT: ${{ needs.prepare-content.outputs.post_long }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ§ª DRY RUN: Would post to LinkedIn"
            echo "ğŸ“ Content preview:"
            echo "$POST_TEXT" | head -c 150
            echo "..."
            echo "status=dry_run" >> $GITHUB_OUTPUT
            exit 0
          fi

          ESCAPED_TEXT=$(echo "$POST_TEXT" | jq -Rs .)

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.linkedin.com/rest/posts" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "LinkedIn-Version: 202401" \
            -H "X-Restli-Protocol-Version: 2.0.0" \
            -H "Content-Type: application/json" \
            -d "{
              \"author\": \"urn:li:person:$PERSON_ID\",
              \"commentary\": $ESCAPED_TEXT,
              \"visibility\": \"PUBLIC\",
              \"distribution\": {
                \"feedDistribution\": \"MAIN_FEED\",
                \"targetEntities\": [],
                \"thirdPartyDistributionChannels\": []
              },
              \"lifecycleState\": \"PUBLISHED\"
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "201" ]; then
            POST_URL="https://www.linkedin.com/feed/"
            echo "âœ… LinkedIn post created successfully!"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "url=$POST_URL" >> $GITHUB_OUTPUT
          else
            echo "âŒ LinkedIn API error: HTTP $HTTP_CODE"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            ERROR_MSG=$(echo "$BODY" | jq -r '.message // .error // "HTTP error"' 2>/dev/null || echo "HTTP $HTTP_CODE")
            echo "status=error" >> $GITHUB_OUTPUT
            echo "error=$ERROR_MSG" >> $GITHUB_OUTPUT
          fi

      - name: Set result outputs
        id: result
        if: always()
        env:
          TOKEN_CONFIGURED: ${{ steps.get-token.outputs.configured }}
          USER_FOUND: ${{ steps.get-user.outputs.user_found }}
          POST_STATUS: ${{ steps.post.outputs.status }}
          POST_URL: ${{ steps.post.outputs.url }}
          POST_ERROR: ${{ steps.post.outputs.error }}
        run: |
          if [ "$TOKEN_CONFIGURED" = "false" ]; then
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "error=LinkedIn not configured" >> $GITHUB_OUTPUT
          elif [ "$USER_FOUND" = "false" ]; then
            echo "status=error" >> $GITHUB_OUTPUT
            echo "error=Failed to get LinkedIn user ID" >> $GITHUB_OUTPUT
          elif [ -n "$POST_STATUS" ]; then
            echo "status=$POST_STATUS" >> $GITHUB_OUTPUT
            echo "url=$POST_URL" >> $GITHUB_OUTPUT
            echo "error=$POST_ERROR" >> $GITHUB_OUTPUT
          else
            echo "status=error" >> $GITHUB_OUTPUT
            echo "error=Unknown error" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Phase 4: Threads í¬ìŠ¤íŒ…
  # ============================================
  post-to-threads:
    name: Post to Threads
    runs-on: ubuntu-latest
    needs: [prepare-content]
    if: needs.prepare-content.outputs.has_posts == 'true'

    outputs:
      status: ${{ steps.result.outputs.status }}
      url: ${{ steps.result.outputs.url }}
      error: ${{ steps.result.outputs.error }}

    steps:
      - name: Check Threads credentials
        id: check-creds
        run: |
          if [ -z "${{ secrets.THREADS_ACCESS_TOKEN }}" ] || \
             [ -z "${{ secrets.THREADS_USER_ID }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Threads credentials not configured, skipping"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "âœ… Threads credentials configured"
          fi

      - name: Create Threads container
        id: container
        if: steps.check-creds.outputs.configured == 'true'
        env:
          ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          USER_ID: ${{ secrets.THREADS_USER_ID }}
          POST_TEXT: ${{ needs.prepare-content.outputs.post_long }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ§ª DRY RUN: Would create Threads container"
            echo "ğŸ“ Content preview:"
            echo "$POST_TEXT" | head -c 150
            echo "..."
            echo "status=dry_run" >> $GITHUB_OUTPUT
            exit 0
          fi

          ENCODED_TEXT=$(python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.stdin.read()))" <<< "$POST_TEXT")

          RESPONSE=$(curl -s -X POST \
            "https://graph.threads.net/v1.0/${USER_ID}/threads?media_type=TEXT&text=${ENCODED_TEXT}&access_token=${ACCESS_TOKEN}")

          CONTAINER_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')

          if [ -n "$CONTAINER_ID" ] && [ "$CONTAINER_ID" != "null" ]; then
            echo "container_id=$CONTAINER_ID" >> $GITHUB_OUTPUT
            echo "container_created=true" >> $GITHUB_OUTPUT
            echo "âœ… Threads container created: $CONTAINER_ID"
          else
            echo "âŒ Failed to create Threads container"
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"
            echo "container_created=false" >> $GITHUB_OUTPUT
            echo "error=$ERROR" >> $GITHUB_OUTPUT
          fi

      - name: Publish Threads post
        id: publish
        if: steps.container.outputs.container_created == 'true'
        env:
          ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          USER_ID: ${{ secrets.THREADS_USER_ID }}
          CONTAINER_ID: ${{ steps.container.outputs.container_id }}
        run: |
          sleep 2

          RESPONSE=$(curl -s -X POST \
            "https://graph.threads.net/v1.0/${USER_ID}/threads_publish?creation_id=${CONTAINER_ID}&access_token=${ACCESS_TOKEN}")

          POST_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')

          if [ -n "$POST_ID" ] && [ "$POST_ID" != "null" ]; then
            POST_URL="https://www.threads.net/post/${POST_ID}"
            echo "âœ… Threads post published: $POST_URL"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "url=$POST_URL" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to publish Threads post"
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"
            echo "status=error" >> $GITHUB_OUTPUT
            echo "error=$ERROR" >> $GITHUB_OUTPUT
          fi

      - name: Set result outputs
        id: result
        if: always()
        env:
          CONFIGURED: ${{ steps.check-creds.outputs.configured }}
          CONTAINER_STATUS: ${{ steps.container.outputs.status }}
          CONTAINER_CREATED: ${{ steps.container.outputs.container_created }}
          CONTAINER_ERROR: ${{ steps.container.outputs.error }}
          PUBLISH_STATUS: ${{ steps.publish.outputs.status }}
          PUBLISH_URL: ${{ steps.publish.outputs.url }}
          PUBLISH_ERROR: ${{ steps.publish.outputs.error }}
        run: |
          if [ "$CONFIGURED" = "false" ]; then
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "error=Threads not configured" >> $GITHUB_OUTPUT
          elif [ "$CONTAINER_STATUS" = "dry_run" ]; then
            echo "status=dry_run" >> $GITHUB_OUTPUT
          elif [ "$CONTAINER_CREATED" = "false" ]; then
            echo "status=error" >> $GITHUB_OUTPUT
            echo "error=$CONTAINER_ERROR" >> $GITHUB_OUTPUT
          elif [ -n "$PUBLISH_STATUS" ]; then
            echo "status=$PUBLISH_STATUS" >> $GITHUB_OUTPUT
            echo "url=$PUBLISH_URL" >> $GITHUB_OUTPUT
            echo "error=$PUBLISH_ERROR" >> $GITHUB_OUTPUT
          else
            echo "status=error" >> $GITHUB_OUTPUT
            echo "error=Unknown error" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Phase 4: ê²°ê³¼ ìˆ˜ì§‘ ë° Summary ìƒì„±
  # ============================================
  collect-results:
    name: Collect Results
    runs-on: ubuntu-latest
    needs: [prepare-content, post-to-x, post-to-linkedin, post-to-threads]
    if: always() && needs.prepare-content.outputs.has_posts == 'true'

    outputs:
      page_id: ${{ needs.prepare-content.outputs.page_id }}
      x_status: ${{ needs.post-to-x.outputs.status }}
      x_url: ${{ needs.post-to-x.outputs.url }}
      linkedin_status: ${{ needs.post-to-linkedin.outputs.status }}
      linkedin_url: ${{ needs.post-to-linkedin.outputs.url }}
      threads_status: ${{ needs.post-to-threads.outputs.status }}
      threads_url: ${{ needs.post-to-threads.outputs.url }}

    steps:
      - name: Generate Platform Results Summary
        env:
          TITLE: ${{ needs.prepare-content.outputs.title }}
          BLOG_URL: ${{ needs.prepare-content.outputs.blog_url }}
          TRANSFORM: ${{ needs.prepare-content.outputs.transform_method }}
          X_STATUS: ${{ needs.post-to-x.outputs.status }}
          X_URL: ${{ needs.post-to-x.outputs.url }}
          X_ERROR: ${{ needs.post-to-x.outputs.error }}
          LI_STATUS: ${{ needs.post-to-linkedin.outputs.status }}
          LI_URL: ${{ needs.post-to-linkedin.outputs.url }}
          LI_ERROR: ${{ needs.post-to-linkedin.outputs.error }}
          TH_STATUS: ${{ needs.post-to-threads.outputs.status }}
          TH_URL: ${{ needs.post-to-threads.outputs.url }}
          TH_ERROR: ${{ needs.post-to-threads.outputs.error }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          echo "## ğŸ“± SNS Auto Post - Platform Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DRY_RUN" = "true" ]; then
            echo "> ğŸ§ª **DRY RUN MODE** - No actual posts were created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### ğŸ“„ Post Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Title | $TITLE |" >> $GITHUB_STEP_SUMMARY
          echo "| Blog URL | $BLOG_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| Transform Method | $TRANSFORM |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸŒ Platform Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          X_STATUS="${X_STATUS:-skipped}"
          case "$X_STATUS" in
            success) echo "| X (Twitter) | âœ… Success | [$X_URL]($X_URL) |" >> $GITHUB_STEP_SUMMARY ;;
            error)   echo "| X (Twitter) | âŒ Error | $X_ERROR |" >> $GITHUB_STEP_SUMMARY ;;
            dry_run) echo "| X (Twitter) | ğŸ§ª Dry Run | Would post |" >> $GITHUB_STEP_SUMMARY ;;
            *)       echo "| X (Twitter) | â­ï¸ Skipped | ${X_ERROR:-Not configured} |" >> $GITHUB_STEP_SUMMARY ;;
          esac

          LI_STATUS="${LI_STATUS:-skipped}"
          case "$LI_STATUS" in
            success) echo "| LinkedIn | âœ… Success | [$LI_URL]($LI_URL) |" >> $GITHUB_STEP_SUMMARY ;;
            error)   echo "| LinkedIn | âŒ Error | $LI_ERROR |" >> $GITHUB_STEP_SUMMARY ;;
            dry_run) echo "| LinkedIn | ğŸ§ª Dry Run | Would post |" >> $GITHUB_STEP_SUMMARY ;;
            *)       echo "| LinkedIn | â­ï¸ Skipped | ${LI_ERROR:-Not configured} |" >> $GITHUB_STEP_SUMMARY ;;
          esac

          TH_STATUS="${TH_STATUS:-skipped}"
          case "$TH_STATUS" in
            success) echo "| Threads | âœ… Success | [$TH_URL]($TH_URL) |" >> $GITHUB_STEP_SUMMARY ;;
            error)   echo "| Threads | âŒ Error | $TH_ERROR |" >> $GITHUB_STEP_SUMMARY ;;
            dry_run) echo "| Threads | ğŸ§ª Dry Run | Would post |" >> $GITHUB_STEP_SUMMARY ;;
            *)       echo "| Threads | â­ï¸ Skipped | ${TH_ERROR:-Not configured} |" >> $GITHUB_STEP_SUMMARY ;;
          esac

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Workflow completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY

          SUCCESS_COUNT=0
          [ "$X_STATUS" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "$LI_STATUS" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "$TH_STATUS" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))

          echo ""
          echo "ğŸ“Š Summary: $SUCCESS_COUNT platform(s) posted successfully"

          # Output for notion-writeback job
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT

  # ============================================
  # Phase 5: Notion Write-back
  # ============================================
  notion-writeback:
    name: Update Notion Status
    runs-on: ubuntu-latest
    needs:
      [
        prepare-content,
        post-to-x,
        post-to-linkedin,
        post-to-threads,
        collect-results,
      ]
    if: always() && needs.prepare-content.outputs.has_posts == 'true'

    steps:
      # ============================================
      # Step 1: ì„±ê³µ íŒì • ë° Dry Run ì²´í¬
      # ============================================
      - name: Check posting results
        id: check
        env:
          X_STATUS: ${{ needs.post-to-x.outputs.status }}
          LI_STATUS: ${{ needs.post-to-linkedin.outputs.status }}
          TH_STATUS: ${{ needs.post-to-threads.outputs.status }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          echo "ğŸ“ Checking posting results for Notion write-back..."

          # Dry Run ì²´í¬
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ§ª DRY RUN: Skipping Notion write-back"
            echo "should_update=false" >> $GITHUB_OUTPUT
            echo "reason=dry_run" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ì„±ê³µ ì¹´ìš´íŠ¸ ê³„ì‚°
          SUCCESS_COUNT=0
          SKIP_COUNT=0
          ERROR_COUNT=0

          # X ìƒíƒœ í™•ì¸
          case "$X_STATUS" in
            success) SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
            skipped) SKIP_COUNT=$((SKIP_COUNT + 1)) ;;
            error)   ERROR_COUNT=$((ERROR_COUNT + 1)) ;;
          esac

          # LinkedIn ìƒíƒœ í™•ì¸
          case "$LI_STATUS" in
            success) SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
            skipped) SKIP_COUNT=$((SKIP_COUNT + 1)) ;;
            error)   ERROR_COUNT=$((ERROR_COUNT + 1)) ;;
          esac

          # Threads ìƒíƒœ í™•ì¸
          case "$TH_STATUS" in
            success) SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
            skipped) SKIP_COUNT=$((SKIP_COUNT + 1)) ;;
            error)   ERROR_COUNT=$((ERROR_COUNT + 1)) ;;
          esac

          echo "ğŸ“Š Results: $SUCCESS_COUNT success, $SKIP_COUNT skipped, $ERROR_COUNT error"

          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "skip_count=$SKIP_COUNT" >> $GITHUB_OUTPUT
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT

          # í•˜ë‚˜ ì´ìƒ ì„±ê³µ ì‹œ ìƒíƒœ ë³€ê²½
          if [ $SUCCESS_COUNT -gt 0 ]; then
            echo "should_update=true" >> $GITHUB_OUTPUT
            echo "reason=success" >> $GITHUB_OUTPUT
            echo "âœ… Will update Notion status to 'Updated'"
          # ì „ì²´ ìŠ¤í‚µ ì‹œ Write-back ìŠ¤í‚µ
          elif [ $SKIP_COUNT -eq 3 ]; then
            echo "should_update=false" >> $GITHUB_OUTPUT
            echo "reason=all_skipped" >> $GITHUB_OUTPUT
            echo "â­ï¸ All platforms skipped, no write-back needed"
          # ì „ì²´ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ë§Œ ê¸°ë¡
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
            echo "should_log=true" >> $GITHUB_OUTPUT
            echo "reason=all_failed" >> $GITHUB_OUTPUT
            echo "âŒ All platforms failed, will only log errors"
          fi

      # ============================================
      # Step 2: ë¡œê·¸ ë©”ì‹œì§€ ìƒì„±
      # ============================================
      - name: Generate log message
        id: log
        if: steps.check.outputs.reason != 'dry_run' && steps.check.outputs.reason != 'all_skipped'
        env:
          X_STATUS: ${{ needs.post-to-x.outputs.status }}
          X_URL: ${{ needs.post-to-x.outputs.url }}
          X_ERROR: ${{ needs.post-to-x.outputs.error }}
          LI_STATUS: ${{ needs.post-to-linkedin.outputs.status }}
          LI_URL: ${{ needs.post-to-linkedin.outputs.url }}
          LI_ERROR: ${{ needs.post-to-linkedin.outputs.error }}
          TH_STATUS: ${{ needs.post-to-threads.outputs.status }}
          TH_URL: ${{ needs.post-to-threads.outputs.url }}
          TH_ERROR: ${{ needs.post-to-threads.outputs.error }}
          TRANSFORM: ${{ needs.prepare-content.outputs.transform_method }}
        run: |
          echo "ğŸ“ Generating log message..."

          # íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S')

          # X ê²°ê³¼ ë¼ì¸
          case "$X_STATUS" in
            success) X_LINE="- X: âœ… $X_URL" ;;
            error)   X_LINE="- X: âŒ $X_ERROR" ;;
            skipped) X_LINE="- X: â­ï¸ ${X_ERROR:-Not configured}" ;;
            *)       X_LINE="- X: â­ï¸ Unknown" ;;
          esac

          # LinkedIn ê²°ê³¼ ë¼ì¸
          case "$LI_STATUS" in
            success) LI_LINE="- LinkedIn: âœ… $LI_URL" ;;
            error)   LI_LINE="- LinkedIn: âŒ $LI_ERROR" ;;
            skipped) LI_LINE="- LinkedIn: â­ï¸ ${LI_ERROR:-Not configured}" ;;
            *)       LI_LINE="- LinkedIn: â­ï¸ Unknown" ;;
          esac

          # Threads ê²°ê³¼ ë¼ì¸
          case "$TH_STATUS" in
            success) TH_LINE="- Threads: âœ… $TH_URL" ;;
            error)   TH_LINE="- Threads: âŒ $TH_ERROR" ;;
            skipped) TH_LINE="- Threads: â­ï¸ ${TH_ERROR:-Not configured}" ;;
            *)       TH_LINE="- Threads: â­ï¸ Unknown" ;;
          esac

          # LLM ë³€í™˜ ë°©ì‹
          if [ "$TRANSFORM" = "ai" ]; then
            LLM_LINE="- LLM: âœ… AI Gateway (gpt-4o)"
          else
            LLM_LINE="- LLM: â­ï¸ Fallback"
          fi

          # ë¡œê·¸ ë©”ì‹œì§€ ì¡°í•©
          LOG_MESSAGE="[$TIMESTAMP] SNS Auto Post
          $X_LINE
          $LI_LINE
          $TH_LINE
          $LLM_LINE"

          # ë©€í‹°ë¼ì¸ ì¶œë ¥ (heredoc ë°©ì‹)
          echo "log_message<<EOFLOG" >> $GITHUB_OUTPUT
          echo "$LOG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOFLOG" >> $GITHUB_OUTPUT

          echo "âœ… Log message generated:"
          echo "$LOG_MESSAGE"

      # ============================================
      # Step 3: í˜„ì¬ systemLog ì¡°íšŒ
      # ============================================
      - name: Get current systemLog
        id: get-log
        if: steps.check.outputs.reason != 'dry_run' && steps.check.outputs.reason != 'all_skipped'
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          PAGE_ID: ${{ needs.prepare-content.outputs.page_id }}
        run: |
          echo "ğŸ“¥ Fetching current systemLog from Notion..."

          RESPONSE=$(curl -s "https://api.notion.com/v1/pages/${PAGE_ID}" \
            -H "Authorization: Bearer ${NOTION_API_KEY}" \
            -H "Notion-Version: 2022-06-28")

          # systemLog ì¶”ì¶œ
          CURRENT_LOG=$(echo "$RESPONSE" | jq -r '.properties.systemLog.rich_text[0].plain_text // ""')

          if [ -n "$CURRENT_LOG" ]; then
            echo "ğŸ“„ Current log length: ${#CURRENT_LOG} chars"
          else
            echo "ğŸ“„ No existing log"
          fi

          # ë©€í‹°ë¼ì¸ ì¶œë ¥
          echo "current_log<<EOFCURRENT" >> $GITHUB_OUTPUT
          echo "$CURRENT_LOG" >> $GITHUB_OUTPUT
          echo "EOFCURRENT" >> $GITHUB_OUTPUT

      # ============================================
      # Step 4: Notion ìƒíƒœ ë³€ê²½ + ë¡œê·¸ ì—…ë°ì´íŠ¸
      # ============================================
      - name: Update Notion page
        id: update
        if: steps.check.outputs.reason != 'dry_run' && steps.check.outputs.reason != 'all_skipped'
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          PAGE_ID: ${{ needs.prepare-content.outputs.page_id }}
          SHOULD_UPDATE: ${{ steps.check.outputs.should_update }}
          CURRENT_LOG: ${{ steps.get-log.outputs.current_log }}
          NEW_LOG: ${{ steps.log.outputs.log_message }}
        run: |
          echo "ğŸ“ Updating Notion page..."

          # ìƒˆ ë¡œê·¸ ë©”ì‹œì§€ ì¡°í•©
          if [ -n "$CURRENT_LOG" ]; then
            FULL_LOG="${CURRENT_LOG}

          ${NEW_LOG}"
          else
            FULL_LOG="$NEW_LOG"
          fi

          # 2000ì ì œí•œ ì²´í¬ (Notion rich_text ì œí•œ)
          LOG_LEN=${#FULL_LOG}
          if [ $LOG_LEN -gt 1900 ]; then
            echo "âš ï¸ Log too long ($LOG_LEN chars), trimming old entries..."
            # ìµœì‹  1800ìë§Œ ìœ ì§€
            FULL_LOG=$(echo "$FULL_LOG" | tail -c 1800)
          fi

          # JSON ì´ìŠ¤ì¼€ì´í”„
          ESCAPED_LOG=$(echo "$FULL_LOG" | jq -Rs .)

          # ìƒíƒœ ë³€ê²½ ì—¬ë¶€ì— ë”°ë¥¸ properties êµ¬ì„±
          if [ "$SHOULD_UPDATE" = "true" ]; then
            echo "âœ… Updating status to 'Updated' and appending log..."
            PROPERTIES="{
              \"ìƒíƒœ\": {
                \"select\": { \"name\": \"Updated\" }
              },
              \"systemLog\": {
                \"rich_text\": [{ \"text\": { \"content\": ${ESCAPED_LOG} } }]
              }
            }"
          else
            echo "ğŸ“ Only appending error log (status remains 'Ready')..."
            PROPERTIES="{
              \"systemLog\": {
                \"rich_text\": [{ \"text\": { \"content\": ${ESCAPED_LOG} } }]
              }
            }"
          fi

          # Notion API í˜¸ì¶œ
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
            "https://api.notion.com/v1/pages/${PAGE_ID}" \
            -H "Authorization: Bearer ${NOTION_API_KEY}" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            -d "{\"properties\": $PROPERTIES}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Notion page updated successfully!"
            echo "status=success" >> $GITHUB_OUTPUT
            if [ "$SHOULD_UPDATE" = "true" ]; then
              echo "status_changed=true" >> $GITHUB_OUTPUT
            else
              echo "status_changed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Notion API error: HTTP $HTTP_CODE"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            echo "status=error" >> $GITHUB_OUTPUT
            echo "error=$(echo "$BODY" | jq -r '.message // "Unknown error"' 2>/dev/null)" >> $GITHUB_OUTPUT
          fi

      # ============================================
      # Step 5: Write-back ê²°ê³¼ Summary ìƒì„±
      # ============================================
      - name: Generate Write-back Summary
        if: always()
        env:
          REASON: ${{ steps.check.outputs.reason }}
          UPDATE_STATUS: ${{ steps.update.outputs.status }}
          STATUS_CHANGED: ${{ steps.update.outputs.status_changed }}
          UPDATE_ERROR: ${{ steps.update.outputs.error }}
          SUCCESS_COUNT: ${{ steps.check.outputs.success_count }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Notion Write-back" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY

          case "$REASON" in
            dry_run)
              echo "| Status Change | ğŸ§ª Skipped (Dry Run) |" >> $GITHUB_STEP_SUMMARY
              echo "| System Log | ğŸ§ª Skipped (Dry Run) |" >> $GITHUB_STEP_SUMMARY
              ;;
            all_skipped)
              echo "| Status Change | â­ï¸ Skipped (No platforms configured) |" >> $GITHUB_STEP_SUMMARY
              echo "| System Log | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
              ;;
            all_failed)
              if [ "$UPDATE_STATUS" = "success" ]; then
                echo "| Status Change | â­ï¸ Kept as Ready (All failed) |" >> $GITHUB_STEP_SUMMARY
                echo "| System Log | âœ… Error log appended |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| Status Change | âŒ API Error |" >> $GITHUB_STEP_SUMMARY
                echo "| System Log | âŒ $UPDATE_ERROR |" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
            success)
              if [ "$UPDATE_STATUS" = "success" ]; then
                echo "| Status Change | âœ… Ready â†’ Updated |" >> $GITHUB_STEP_SUMMARY
                echo "| System Log | âœ… Appended ($SUCCESS_COUNT platform(s)) |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| Status Change | âŒ API Error |" >> $GITHUB_STEP_SUMMARY
                echo "| System Log | âŒ $UPDATE_ERROR |" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
            *)
              echo "| Status Change | â“ Unknown |" >> $GITHUB_STEP_SUMMARY
              echo "| System Log | â“ Unknown |" >> $GITHUB_STEP_SUMMARY
              ;;
          esac

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Write-back completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
